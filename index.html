<script type="text/babel">
    const { useState, useMemo } = React;

    const MisoYonApp = () => {
        const [isAdmin, setIsAdmin] = useState(true); 
        const [menuMaster, setMenuMaster] = useState([]); 
        const [mealPlan, setMealPlan] = useState([]); 
        const [searchQuery, setSearchQuery] = useState("");

        const handleUpload = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (evt) => {
                const bstr = evt.target.result;
                const wb = XLSX.read(bstr, { type: 'binary' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                const sanitized = data.map((row, i) => {
                    // [핵심 수정] 엑셀 제목이 달라도 유사한 단어를 찾아내도록 설정
                    const name = row['메뉴명'] || row['메뉴'] || row['음식명'] || row['상품명'] || Object.values(row)[0];
                    const kcal = parseInt(row['칼로리'] || row['energy'] || row['kcal']) || 0;
                    const protein = parseInt(row['단백질'] || row['protein']) || 0;
                    
                    return { id: i, name, kcal, protein, category: row['카테고리'] || '일반' };
                });
                setMenuMaster(sanitized);
            };
            reader.readAsBinaryString(file);
        };

        const nutrition = useMemo(() => {
            return mealPlan.reduce((acc, cur) => ({
                kcal: acc.kcal + cur.kcal,
                protein: acc.protein + cur.protein
            }), { kcal: 0, protein: 0 });
        }, [mealPlan]);

        const handlePrint = () => window.print();

        return (
            /* 기존 UI 코드와 동일 (생략 가능하나 전체 복사를 위해 유지) */
            <div className="min-h-screen bg-gray-50 pb-20">
                <nav className={`p-4 text-white flex justify-between items-center ${isAdmin ? 'bg-red-700' : 'bg-blue-800'}`}>
                    <h1 className="font-black">MISOYON MMS v1.1</h1>
                </nav>
                <div className="max-w-4xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
                    <div className="lg:col-span-4 space-y-4">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                            <h3 className="font-bold text-xs text-gray-400 mb-3">엑셀 파일을 다시 올려주세요</h3>
                            <input type="file" onChange={handleUpload} className="text-xs w-full" />
                        </div>
                        <div className="bg-white p-5 rounded-2xl shadow-sm border">
                            <input 
                                placeholder="메뉴 검색..." 
                                className="w-full p-3 bg-gray-50 rounded-xl mb-4 border"
                                onChange={(e) => setSearchQuery(e.target.value)}
                            />
                            <div className="max-h-64 overflow-y-auto space-y-2">
                                {menuMaster.filter(m => String(m.name).includes(searchQuery)).map(m => (
                                    <div key={m.id} onClick={() => setMealPlan([...mealPlan, m])} className="p-3 border rounded-xl hover:bg-blue-50 cursor-pointer flex justify-between items-center text-sm font-bold">
                                        <span>{m.name}</span>
                                        <span className="text-blue-500">+</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="lg:col-span-8">
                        <div className="bg-white p-6 rounded-3xl shadow-sm border">
                            <div className="flex justify-between items-end mb-6">
                                <h2 className="text-2xl font-black">오늘의 식단</h2>
                                <div className="text-right">
                                    <p className="text-lg font-bold text-blue-600">{nutrition.kcal}kcal / {nutrition.protein}g</p>
                                </div>
                            </div>
                            <div className="space-y-3 min-h-[200px] border-t pt-6">
                                {mealPlan.map((m, idx) => (
                                    <div key={idx} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl">
                                        <span className="font-bold">{m.name}</span>
                                        <button onClick={() => setMealPlan(mealPlan.filter((_, i) => i !== idx))} className="text-red-300">삭제</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<MisoYonApp />);
</script>
