<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MISOYON MMS v12.1 - Î≥µÍµ¨ Î∞è ÏïàÏ†ïÌôî</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; }
        html, body, #root { width: 100%; height: 100%; overflow: hidden; background: #f1f5f9; }
        
        .main-container { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        .content-area { display: flex; flex: 1; overflow: hidden; }
        
        /* Ï∫òÎ¶∞Îçî Íµ¨Ïó≠ */
        .calendar-section { flex: 3; display: flex; flex-direction: column; background: #cbd5e1; border-right: 1px solid #cbd5e1; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: 25px repeat(6, 1fr); flex: 1; gap: 1px; }
        .day-cell { background: white; padding: 4px; cursor: pointer; display: flex; flex-direction: column; min-height: 0; transition: 0.2s; }
        .day-cell:hover { background: #f8fafc; }
        .day-cell.selected { background: #eff6ff !important; box-shadow: inset 0 0 0 2px #3b82f6; z-index: 5; }
        
        /* Î©îÎâ¥ ÌÖçÏä§Ìä∏ */
        .menu-label { font-size: 9px; font-weight: 800; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; padding: 1px 3px; border-radius: 3px; }
        
        /* Î†àÏãúÌîº Ïπ¥Îìú */
        .recipe-clickable { cursor: pointer !important; }
        .recipe-clickable:hover { border-color: #3b82f6 !important; background: #f0f7ff !important; }
        
        /* ÌåùÏóÖ Î†àÏù¥Ïñ¥ */
        .layer-fixed { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-body { background: white; border-radius: 20px; width: 95%; max-width: 700px; max-height: 85vh; overflow-y: auto; padding: 25px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        
        .hl-red { color: #ef4444; font-weight: 900; text-decoration: underline; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const MisoYonApp = () => {
            const MENU_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnsej-xGogyedNPYTs2iqEMFKAwIL3tipLoSiDDKxKHot-PITnmxYETDseGckqpb6EMiQm39Sfol0-/pub?output=csv";
            const RECIPE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS59rKx1l0C9M20mY_VqS3_3R_z7-mX3YxG0-v8l_z1K0/pub?gid=949808515&output=csv"; 

            const [menus, setMenus] = useState([]);
            const [recipes, setRecipes] = useState({});
            const [selectedDate, setSelectedDate] = useState(null);
            const [currentMonth, setCurrentMonth] = useState(new Date(2026, 0, 1));
            const [searchTerm, setSearchTerm] = useState("");
            const [modalSearch, setModalSearch] = useState("");
            const [activeModal, setActiveModal] = useState(false);
            const [viewRecipes, setViewRecipes] = useState([]); 

            const loadData = () => {
                // Î©îÎâ¥ ÌååÏã±
                Papa.parse(MENU_URL, { download: true, complete: (res) => {
                    let temp = []; let headers = [];
                    res.data.forEach(row => {
                        const label = (row[0] || "").replace(/\s/g, "");
                        if (label === "ÎÇ†Ïßú") {
                            headers = row.slice(1).map(v => {
                                const m = (v || "").match(/(\d{4})[^\d]*(\d{1,2})[^\d]*(\d{1,2})/);
                                return m ? `${m[1]}-${m[2].padStart(2, '0')}-${m[3].padStart(2, '0')}` : null;
                            });
                            headers.forEach(d => { if(d) temp.push({ date: d, morning: "", lunch: "", dinner: "" }); });
                        } else if (headers.length > 0) {
                            row.slice(1).forEach((v, i) => {
                                if (!headers[i]) return;
                                const t = temp.find(m => m.date === headers[i]);
                                if (t) {
                                    if (label.includes("ÏïÑÏπ®")) t.morning = v;
                                    else if (label.includes("Ï†êÏã¨")) t.lunch = v;
                                    else if (label.includes("Ï†ÄÎÖÅ")) t.dinner = v;
                                }
                            });
                        }
                    });
                    setMenus(temp);
                }});
                // Î†àÏãúÌîº ÌååÏã±
                Papa.parse(RECIPE_URL, { download: true, complete: (res) => {
                    const map = {}; let cur = null;
                    res.data.forEach(row => {
                        if ((row[0] || "").trim() === "Í∏∞Î≥∏Ï†ïÎ≥¥") {
                            cur = (row[1] || "").trim();
                            map[cur] = { name: cur, ingredients: "", process: "", tip: "" };
                        } else if (cur && map[cur]) {
                            if (row[0]?.includes("ÏãùÏû¨Î£å")) map[cur].ingredients += (row[1] + " ");
                            if (row[0]?.includes("Ï°∞Î¶¨Í≥µÏ†ï")) map[cur].process += (row[1] + "\n");
                            if (row[0]?.includes("Ï†ÑÎ¨∏Í∞ÄTIP")) map[cur].tip = row[1];
                        }
                    });
                    setRecipes(map);
                }});
            };

            useEffect(() => { loadData(); }, []);

            // ÏÖ∞ÌîÑÎãò ÏöîÏ≤≠: Î∂àÍ≥†Í∏∞, Í∞ÄÏÉÅÌï¥ÏÇº Îì± Î∂ÄÎ∂Ñ ÏùºÏπò Í≤ÄÏÉâ Î°úÏßÅ
            const getMatches = (menu) => {
                if (!menu || menu === "ÏùºÏ†ïÏóÜÏùå") return [];
                const target = menu.replace(/\s/g, "").toLowerCase();
                return Object.values(recipes).filter(r => {
                    const rName = r.name.replace(/\s/g, "").toLowerCase();
                    return target.includes(rName) || rName.includes(target) || (target.length > 2 && rName.includes(target.substring(0,2)));
                });
            };

            const days = useMemo(() => {
                const year = currentMonth.getFullYear(), month = currentMonth.getMonth();
                const first = new Date(year, month, 1).getDay();
                const last = new Date(year, month + 1, 0).getDate();
                const arr = Array(first).fill(null);
                for (let i = 1; i <= last; i++) {
                    const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    arr.push({ day: i, dateStr: ds, data: menus.find(m => m.date === ds) });
                }
                while (arr.length < 42) arr.push(null);
                return arr;
            }, [currentMonth, menus]);

            const results = useMemo(() => {
                const q = (activeModal ? modalSearch : searchTerm).trim().toLowerCase();
                if (!q) return [];
                return menus.filter(m => (m.morning+m.lunch+m.dinner).toLowerCase().includes(q)).sort((a,b)=>new Date(b.date)-new Date(a.date));
            }, [modalSearch, searchTerm, activeModal, menus]);

            const highlight = (txt, q) => {
                if (!q || !txt || !isNaN(q)) return txt;
                const parts = txt.split(new RegExp(`(${q})`, 'gi'));
                return parts.map((p, i) => p.toLowerCase() === q.toLowerCase() ? <span key={i} className="hl-red">{p}</span> : p);
            };

            const MenuCard = ({text, type, query}) => {
                const matched = getMatches(text);
                const has = matched.length > 0;
                return (
                    <div className={`p-3 rounded-xl border mb-2 transition-all ${has ? 'bg-blue-50 border-blue-200 recipe-clickable' : 'bg-slate-50 border-slate-100'}`}
                         onClick={() => has && setViewRecipes(matched)}>
                        <div className="flex justify-between items-center mb-1">
                            <span className="text-[9px] font-black text-slate-400 uppercase">{type}</span>
                            {has && <span className="text-blue-600 font-black text-[9px]">üìã RECIPE</span>}
                        </div>
                        <div className="text-[12px] font-black text-slate-800 leading-tight">
                            {highlight(text, query)}
                        </div>
                    </div>
                );
            };

            return (
                <div className="main-container">
                    <header className="h-14 bg-white border-b flex items-center justify-between px-6 shrink-0 shadow-sm z-10">
                        <div className="flex items-center gap-6">
                            <h1 className="text-xl font-black italic tracking-tighter">MISOYON <span className="text-blue-600">v12.1</span></h1>
                            <div className="flex bg-slate-100 p-1 rounded-lg border font-black text-sm">
                                <select className="bg-transparent px-2" value={currentMonth.getFullYear()} onChange={e=>setCurrentMonth(new Date(e.target.value, currentMonth.getMonth()))}>
                                    {[2024, 2025, 2026].map(y=><option key={y} value={y}>{y}ÎÖÑ</option>)}
                                </select>
                                <select className="bg-transparent px-2" value={currentMonth.getMonth()+1} onChange={e=>setCurrentMonth(new Date(currentMonth.getFullYear(), e.target.value-1))}>
                                    {Array.from({length:12},(_,i)=>i+1).map(m=><option key={m} value={m}>{m}Ïõî</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <input className="bg-slate-100 px-4 py-1.5 rounded-xl text-xs font-bold w-56 border-2 border-transparent focus:border-blue-500 outline-none" 
                                   placeholder="Î©îÎâ¥ Í≤ÄÏÉâ (Ïòà: Î∂àÍ≥†Í∏∞)" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} onKeyDown={e=>e.key==='Enter' && (setModalSearch(searchTerm), setActiveModal(true))}/>
                            <button onClick={()=>{setModalSearch(searchTerm); setActiveModal(true);}} className="bg-blue-600 text-white px-4 py-1.5 rounded-xl text-xs font-black">SEARCH</button>
                        </div>
                    </header>

                    <div className="content-area">
                        <div className="calendar-section">
                            <div className="calendar-grid">
                                {['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d=><div key={d} className="bg-slate-50 py-1 text-center text-[9px] font-black text-slate-400 border-b">{d}</div>)}
                                {days.map((d,i)=>(
                                    <div key={i} className={`day-cell ${d?.dateStr === selectedDate?.date ? 'selected' : ''}`} onClick={()=>d?.data && setSelectedDate(d.data)}>
                                        {d && (
                                            <>
                                                <span className={`text-[10px] font-black ${d.data ? 'text-slate-900' : 'text-slate-200'}`}>{d.day}</span>
                                                {d.data && (
                                                    <div className="flex flex-col gap-[1px]">
                                                        <div className="menu-label bg-orange-50 text-orange-600">Ï°∞:{d.data.morning}</div>
                                                        <div className="menu-label bg-blue-50 text-blue-600">Ï§ë:{d.data.lunch}</div>
                                                        <div className="menu-label bg-purple-50 text-purple-600">ÏÑù:{d.data.dinner}</div>
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <aside className="w-80 bg-white p-5 overflow-y-auto shadow-inner border-l">
                            {selectedDate ? (
                                <div className="space-y-5">
                                    <div className="border-b-2 border-slate-900 pb-1">
                                        <h2 className="text-lg font-black italic uppercase">Daily Menus</h2>
                                        <p className="text-blue-600 font-bold text-xs">{selectedDate.date}</p>
                                    </div>
                                    <MenuCard text={selectedDate.morning} type="Breakfast" />
                                    <MenuCard text={selectedDate.lunch} type="Lunch" />
                                    <MenuCard text={selectedDate.dinner} type="Dinner" />
                                </div>
                            ) : <div className="h-full flex items-center justify-center text-slate-300 font-black text-xs uppercase italic text-center">ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌïòÎ©¥<br/>Î©îÎâ¥Í∞Ä ÌëúÏãúÎê©ÎãàÎã§</div>}
                        </aside>
                    </div>

                    {/* Î†àÏãúÌîº ÌåùÏóÖ */}
                    {viewRecipes.length > 0 && (
                        <div className="layer-fixed" onClick={()=>setViewRecipes([])}>
                            <div className="modal-body" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center border-b pb-3 mb-5">
                                    <h3 className="text-xl font-black text-blue-600 italic">RECIPE VIEW</h3>
                                    <button onClick={()=>setViewRecipes([])} className="text-3xl font-thin">&times;</button>
                                </div>
                                <div className="space-y-8">
                                    {viewRecipes.map((r,i)=>(
                                        <div key={i} className="animate-in fade-in slide-in-from-bottom-2">
                                            <div className="bg-slate-900 text-white px-4 py-1 rounded-full inline-block text-[11px] font-black mb-4">{r.name}</div>
                                            <div className="grid md:grid-cols-2 gap-4">
                                                <div className="bg-slate-50 p-4 rounded-xl border">
                                                    <div className="text-[10px] font-black text-slate-400 mb-2">INGREDIENTS</div>
                                                    <div className="text-xs font-bold text-slate-700 leading-relaxed">{r.ingredients}</div>
                                                </div>
                                                <div className="bg-slate-50 p-4 rounded-xl border">
                                                    <div className="text-[10px] font-black text-slate-400 mb-2">PROCESS</div>
                                                    <div className="text-xs font-bold text-slate-700 leading-relaxed whitespace-pre-wrap">{r.process}</div>
                                                </div>
                                            </div>
                                            {r.tip && (
                                                <div className="mt-3 p-3 bg-orange-50 border border-orange-100 rounded-xl flex gap-2">
                                                    <span className="text-sm">üë®‚Äçüç≥</span>
                                                    <p className="text-xs font-bold text-orange-900 italic">{r.tip}</p>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Î∂ÑÏÑù Î™®Îã¨ */}
                    {activeModal && (
                        <div className="layer-fixed">
                            <div className="bg-white w-full h-full flex flex-col p-6 overflow-hidden">
                                <div className="flex justify-between items-center border-b-4 border-blue-600 pb-3 mb-6 shrink-0">
                                    <div className="flex items-center gap-6">
                                        <h2 className="text-2xl font-black italic uppercase">Analysis</h2>
                                        <input className="bg-slate-100 px-6 py-2 rounded-xl text-sm font-black outline-none border-2 border-blue-500 w-80" 
                                               value={modalSearch} onChange={e=>setModalSearch(e.target.value)} placeholder="Î∂ÑÏÑù ÎÇ¥ Ïû¨Í≤ÄÏÉâ..."/>
                                    </div>
                                    <button onClick={()=>setActiveModal(false)} className="text-5xl font-thin">&times;</button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-4 pb-10 pr-2">
                                    {results.map((m,i)=>(
                                        <div key={i} className="bg-white p-5 rounded-3xl border-2 flex flex-col md:flex-row gap-6 hover:border-blue-300 transition-all">
                                            <div className="w-32 shrink-0 border-r">
                                                <div className="text-xl font-black text-blue-600">{m.date.slice(5)}</div>
                                                <div className="text-[10px] font-black text-slate-400 uppercase">{new Date(m.date).toLocaleDateString('ko-KR',{weekday:'long'})}</div>
                                            </div>
                                            <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
                                                <MenuCard text={m.morning} type="Morning" query={modalSearch} />
                                                <MenuCard text={m.lunch} type="Lunch" query={modalSearch} />
                                                <MenuCard text={m.dinner} type="Dinner" query={modalSearch} />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MisoYonApp />);
    </script>
</body>
</html>
