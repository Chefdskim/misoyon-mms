<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>미소연 통합 메뉴 관리 v1.2</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.8/mammoth.browser.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo } = React;

        const MisoYonApp = () => {
            const [menuMaster, setMenuMaster] = useState([]);
            const [mealPlan, setMealPlan] = useState([]);
            const [loading, setLoading] = useState(false);

            // 통합 파일 판독 엔진
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setLoading(true);

                const fileName = file.name.toLowerCase();
                
                try {
                    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls') || fileName.endsWith('.csv')) {
                        // 1. 엑셀/CSV 처리
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const wb = XLSX.read(evt.target.result, { type: 'binary' });
                            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            processRawData(data);
                        };
                        reader.readAsBinaryString(file);
                    } 
                    else if (fileName.endsWith('.docx')) {
                        // 2. 워드 처리
                        const reader = new FileReader();
                        reader.onload = async (evt) => {
                            const result = await mammoth.extractRawText({ arrayBuffer: evt.target.result });
                            processTextData(result.value);
                        };
                        reader.readAsArrayBuffer(file);
                    } 
                    else if (fileName.endsWith('.pdf')) {
                        // 3. PDF 처리
                        const reader = new FileReader();
                        reader.onload = async (evt) => {
                            const typedarray = new Uint8Array(evt.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = "";
                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const content = await page.getTextContent();
                                fullText += content.items.map(item => item.str).join(" ");
                            }
                            processTextData(fullText);
                        };
                        reader.readAsArrayBuffer(file);
                    }
                } catch (err) {
                    alert("파일을 읽는 중 오류가 발생했습니다.");
                } finally {
                    setLoading(false);
                }
            };

            // 데이터를 시스템 형식으로 변환 (셰프님 파일 맞춤형)
            const processRawData = (data) => {
                const sanitized = data.map((row, i) => ({
                    id: i,
                    name: row['메뉴명'] || row['메뉴'] || Object.values(row).find(v => typeof v === 'string' && v.length > 1) || "이름없음",
                    kcal: parseInt(row['칼로리']) || 0,
                    protein: parseInt(row['단백질']) || 0
                }));
                setMenuMaster(sanitized);
            };

            const processTextData = (text) => {
                // 텍스트에서 메뉴로 추정되는 단어들을 추출하는 로직 (간단 구현)
                const lines = text.split(/[,\n]/).filter(l => l.trim().length > 1);
                const sanitized = lines.map((line, i) => ({
                    id: `text-${i}`,
                    name: line.trim(),
                    kcal: 0,
                    protein: 0
                }));
                setMenuMaster(sanitized);
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 lg:p-10 font-sans">
                    <header className="max-w-5xl mx-auto mb-10 flex justify-between items-center">
                        <h1 className="text-3xl font-black text-slate-800 tracking-tight">MISOYON <span className="text-blue-600">MMS v1.2</span></h1>
                        <div className="bg-white px-4 py-2 rounded-2xl shadow-sm border border-slate-200">
                            <label className="text-xs font-bold text-slate-400 block mb-1 uppercase">Smart Import (XL, PDF, DOC)</label>
                            <input type="file" onChange={handleFileUpload} className="text-xs" accept=".xlsx, .xls, .csv, .pdf, .docx" />
                        </div>
                    </header>

                    <div className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <aside className="lg:col-span-4 bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                            <h2 className="font-bold text-slate-800 mb-4">로드된 메뉴 목록 {loading && " (분석 중...)"}</h2>
                            <div className="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                                {menuMaster.map(m => (
                                    <div key={m.id} onClick={() => setMealPlan([...mealPlan, m])} className="p-4 bg-slate-50 rounded-2xl border border-transparent hover:border-blue-400 cursor-pointer transition-all active:scale-95">
                                        <p className="font-bold text-slate-700">{m.name}</p>
                                        <p className="text-[10px] text-slate-400">{m.kcal}kcal / 단백질 {m.protein}g</p>
                                    </div>
                                ))}
                            </div>
                        </aside>

                        <main className="lg:col-span-8 bg-white p-8 rounded-3xl shadow-xl border border-blue-50 relative overflow-hidden">
                            <div className="flex justify-between items-end mb-8 border-b pb-6">
                                <div>
                                    <h2 className="text-2xl font-black text-slate-800">오늘의 식단표</h2>
                                    <p className="text-slate-400 text-sm italic">선택된 메뉴가 자동으로 합산됩니다.</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-4xl font-black text-blue-600 tracking-tighter">
                                        {mealPlan.reduce((a,b)=>a+b.kcal, 0)} <span className="text-sm font-normal text-slate-400">kcal</span>
                                    </p>
                                </div>
                            </div>
                            
                            <div className="space-y-3 min-h-[300px]">
                                {mealPlan.map((m, i) => (
                                    <div key={i} className="flex justify-between items-center p-5 bg-blue-50 rounded-2xl border border-blue-100 animate-in slide-in-from-right-4 duration-300">
                                        <span className="text-lg font-bold text-blue-900">{m.name}</span>
                                        <button onClick={() => setMealPlan(mealPlan.filter((_, idx) => idx !== i))} className="text-red-400 hover:text-red-600 font-bold">삭제</button>
                                    </div>
                                ))}
                            </div>
                            
                            <button onClick={() => window.print()} className="w-full mt-10 py-5 bg-slate-900 text-white rounded-2xl font-black text-lg hover:bg-blue-600 transition-colors shadow-lg">
                                식단 보고서 출력하기 (PDF)
                            </button>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MisoYonApp />);
    </script>
</body>
</html>
